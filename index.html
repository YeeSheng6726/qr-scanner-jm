<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JooyMedia QR Scanner</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #FF6B35 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
    .logo {
      width: 120px;
      height: 60px;
      margin: 0 auto 20px auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 1.8em;
    }
    .step { display: none; animation: fadeIn 0.5s ease-in; }
    .step.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }
    input:focus { outline: none; border-color: #FF6B35; }
    button {
      background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 15px;
      transition: transform 0.2s;
    }
    button:hover { transform: translateY(-2px); }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .file-input {
      border: 2px dashed #FF6B35;
      padding: 30px;
      border-radius: 10px;
      margin: 20px 0;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .file-input:hover { background-color: #fff5f2; }
    .file-input input { display: none; }
    .result, .error, .success, .already-checked-in, .debug {
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .result { background: #f0f8f0; border: 2px solid #4CAF50; }
    .error { background: #fff0f0; border: 2px solid #f44336; color: #f44336; }
    .success { background: #f0f8f0; border: 2px solid #4CAF50; color: #4CAF50; }
    .already-checked-in { background: #fff8e1; border: 2px solid #ff9800; color: #e65100; }
    .debug { background: #f5f5f5; border: 2px solid #666; color: #333; text-align: left; font-family: monospace; font-size: 12px; }
    .loading {
      display: inline-block;
      width: 20px; height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #FF6B35;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    /* Mobile fixes */
    @media (max-width: 600px) {
      h1 { font-size: 1.4em; }
      input, button { font-size: 14px; padding: 12px; }
      .file-input { padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="JM-logo.png" alt="JooyMedia Logo" style="max-width:150px; height:auto;">
    </div>
    <h1>JooyMedia QR Scanner</h1>
    <!-- Step 1: Passcode -->
    <div class="step active" id="step1">
      <h2>Enter Passcode</h2>
      <input type="password" id="passcode" placeholder="Enter event passcode" />
      <button onclick="verifyPasscode()">Verify Passcode</button>
      <div id="passcode-error"></div>
    </div>
    <!-- Step 2: QR Scanner -->
    <div class="step" id="step2">
      <h2>Scan QR Code</h2>
      <div class="file-input" onclick="document.getElementById('qrFile').click()">
        <input type="file" id="qrFile" accept="image/*" onchange="handleFileSelect(event)">
        <p>üì∑ Click to upload QR code image</p>
        <small>Supports JPG, PNG, HEIC (iPhone), GIF</small>
      </div>
      <button onclick="processQR()" id="processBtn" disabled>Process QR Code</button>
      <button onclick="testWebhook()" style="background: #666; margin-top: 10px;">üîß Test Webhook Connection</button>
      <div id="qr-result"></div>
    </div>
    <!-- Step 3: Success -->
    <div class="step" id="step3">
      <h2 id="result-title">‚úÖ Success!</h2>
      <div id="final-result"></div>
      <button onclick="resetScanner()">Scan Another QR Code</button>
    </div>
  </div>
<script>
let selectedFile = null;
const CONFIG = {
  PASSCODE: 'JM8888',
  WEBHOOK_URL: 'https://jooymedia.zeabur.app/webhook-test/b744552e-0801-408d-a84e-267196b27730'
};

function verifyPasscode() {
  const passcode = document.getElementById('passcode').value;
  const errorDiv = document.getElementById('passcode-error');
  if (passcode === CONFIG.PASSCODE) {
    showStep(2);
  } else {
    errorDiv.innerHTML = '<div class="error">‚ùå Invalid passcode. Please try again.</div>';
  }
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (file) {
    selectedFile = file;
    document.getElementById('processBtn').disabled = false;
    document.getElementById('qr-result').innerHTML =
      `<div style="color:#667eea;">üì∑ Image selected: ${file.name}</div>`;
  }
}

// Test webhook connectivity
async function testWebhook() {
  const resultDiv = document.getElementById('qr-result');
  resultDiv.innerHTML = '<div class="loading"></div>Testing webhook connection...';
  
  try {
    console.log('Testing webhook URL:', CONFIG.WEBHOOK_URL);
    
    const testPayload = { 
      test: true,
      qr_data: "TEST_TICKET_123", 
      timestamp: new Date().toISOString(), 
      source: 'connection_test' 
    };
    
    const response = await fetch(CONFIG.WEBHOOK_URL, {
      method: 'POST', 
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }, 
      body: JSON.stringify(testPayload)
    });
    
    console.log('Response status:', response.status);
    console.log('Response headers:', response.headers);
    
    const responseText = await response.text();
    console.log('Response body:', responseText);
    
    if (response.ok) {
      resultDiv.innerHTML = `
        <div class="success">‚úÖ Webhook connection successful!</div>
        <div class="debug">
          <strong>Response Status:</strong> ${response.status}<br>
          <strong>Response Body:</strong><br>${responseText}
        </div>
      `;
    } else {
      resultDiv.innerHTML = `
        <div class="error">‚ùå Webhook returned error status: ${response.status}</div>
        <div class="debug">
          <strong>Response Body:</strong><br>${responseText}
        </div>
      `;
    }
    
  } catch (error) {
    console.error('Webhook test error:', error);
    resultDiv.innerHTML = `
      <div class="error">‚ùå Webhook connection failed: ${error.message}</div>
      <div class="debug">
        <strong>Error Details:</strong><br>
        Type: ${error.name}<br>
        Message: ${error.message}<br>
        <br>
        <strong>Possible causes:</strong><br>
        - Webhook URL is incorrect<br>
        - Server is down<br>
        - CORS policy blocking request<br>
        - Network connectivity issues
      </div>
    `;
  }
}

// Convert any image (HEIC, PNG, JPG) ‚Üí resized JPEG (max 1000px)
function shrinkImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        let width = img.width, height = img.height;
        const MAX = 1000;
        if (width > height && width > MAX) {
          height *= MAX / width; width = MAX;
        } else if (height > MAX) {
          width *= MAX / height; height = MAX;
        }
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);
        canvas.toBlob(blob => resolve(new File([blob], "qr.jpg", { type: "image/jpeg" })), "image/jpeg", 0.8);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function processQR() {
  if (!selectedFile) { 
    showError('Please select an image file first.'); 
    return; 
  }
  
  const btn = document.getElementById('processBtn');
  btn.disabled = true; 
  btn.innerHTML = '<span class="loading"></span>Processing...';
  
  try {
    console.log('Starting QR processing...');
    
    const smallFile = await shrinkImage(selectedFile);
    console.log('Image resized successfully');
    
    const formData = new FormData();
    formData.append('file', smallFile);
    
    console.log('Sending to QR API...');
    const response = await fetch('https://api.qrserver.com/v1/read-qr-code/', { 
      method: 'POST', 
      body: formData 
    });
    
    const result = await response.json();
    console.log('QR API result:', result);
    
    const qrData = result[0]?.symbol[0]?.data;
    
    if (qrData) {
      console.log('QR data extracted:', qrData);
      showQRResult(qrData);
      await sendToWebhook(qrData);
    } else {
      showError('‚ö†Ô∏è Could not read QR code. Please try again or enter manually.');
      console.log('Failed to extract QR data from result:', result);
    }
  } catch (err) {
    console.error('QR processing error:', err);
    showError('Error processing QR: ' + err.message);
  } finally {
    btn.disabled = false; 
    btn.innerHTML = 'Process QR Code';
  }
}

function showQRResult(qrData) {
  document.getElementById('qr-result').innerHTML = `
    <div class="result">
      üì± QR Code Decoded: <strong>${qrData}</strong><br>
      Now sending to webhook...
    </div>
  `;
}

async function sendToWebhook(qrData) {
  const payload = { 
    qr_data: qrData, 
    timestamp: new Date().toISOString(), 
    source: 'custom_scanner' 
  };
  
  console.log('Sending payload to webhook:', payload);
  
  try {
    const response = await fetch(CONFIG.WEBHOOK_URL, {
      method: 'POST', 
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }, 
      body: JSON.stringify(payload)
    });
    
    console.log('Webhook response status:', response.status);
    console.log('Webhook response headers:', response.headers);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('Webhook error response:', errorText);
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    // Parse the response from your n8n workflow
    const webhookResponse = await response.json();
    console.log('Webhook response data:', webhookResponse);
    
    // Handle different response types
    if (webhookResponse.success === true && webhookResponse.status === 'checked_in') {
      // SUCCESS: New check-in
      showCheckInSuccess(webhookResponse);
    } else if (webhookResponse.success === false && webhookResponse.status === 'already_checked_in') {
      // ERROR: Already checked in
      showAlreadyCheckedIn(webhookResponse);
    } else {
      // Fallback for unexpected responses
      showGenericSuccess(qrData, webhookResponse);
    }
    
  } catch (error) {
    console.error('Webhook error:', error);
    showError('Failed to process check-in: ' + error.message);
    
    // Show debug info
    document.getElementById('qr-result').innerHTML += `
      <div class="debug">
        <strong>Debug Info:</strong><br>
        QR Data: ${qrData}<br>
        Webhook URL: ${CONFIG.WEBHOOK_URL}<br>
        Error: ${error.message}
      </div>
    `;
  }
}

function showCheckInSuccess(webhookResponse) {
  document.getElementById('result-title').innerHTML = '‚úÖ Check-in Successful!';
  document.getElementById('final-result').innerHTML =
    `<div class="success">
       <h3>Welcome to the event! üéâ</h3>
       <p><strong>Name:</strong> ${webhookResponse.name || 'N/A'}</p>
       <p><strong>Ticket:</strong> ${webhookResponse.ticket_number}</p>
       <p><strong>Status:</strong> Successfully checked in</p>
       <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
     </div>`;
  showStep(3);
}

function showAlreadyCheckedIn(webhookResponse) {
  document.getElementById('result-title').innerHTML = '‚ö†Ô∏è Already Checked In';
  document.getElementById('final-result').innerHTML =
    `<div class="already-checked-in">
       <h3>This ticket has already been used</h3>
       <p><strong>Ticket:</strong> ${webhookResponse.ticket_number}</p>
       <p><strong>Status:</strong> Already checked in</p>
       <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
       <p><em>Please contact event staff if this is an error.</em></p>
     </div>`;
  showStep(3);
}

function showGenericSuccess(qrData, webhookResponse) {
  document.getElementById('result-title').innerHTML = '‚úÖ QR Code Processed';
  document.getElementById('final-result').innerHTML =
    `<div class="success">
       <h3>QR Code Processed Successfully!</h3>
       <p><strong>Ticket:</strong> ${qrData}</p>
       <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
       ${webhookResponse ? `<div class="debug">Response: ${JSON.stringify(webhookResponse)}</div>` : ''}
     </div>`;
  showStep(3);
}

function showError(msg) {
  document.getElementById('qr-result').innerHTML = `<div class="error">${msg}</div>`;
}

function showStep(n) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById(`step${n}`).classList.add('active');
}

function toggleMode() {
  CONFIG.USE_PRODUCTION = !CONFIG.USE_PRODUCTION;
  const btn = document.getElementById('modeBtn');
  const mode = CONFIG.USE_PRODUCTION ? 'PRODUCTION' : 'TEST';
  const switchTo = CONFIG.USE_PRODUCTION ? 'TEST' : 'PRODUCTION';
  
  btn.textContent = `Switch to ${switchTo} Mode`;
  btn.style.background = CONFIG.USE_PRODUCTION ? '#F44336' : '#4CAF50';
  
  document.getElementById('qr-result').innerHTML = `
    <div style="color: ${CONFIG.USE_PRODUCTION ? '#F44336' : '#4CAF50'}; font-weight: bold;">
      üì° Now using ${mode} webhook
    </div>
  `;
  
  console.log(`Switched to ${mode} mode`);
}

function resetScanner() {
  selectedFile = null;
  document.getElementById('qrFile').value = '';
  document.getElementById('processBtn').disabled = true;
  document.getElementById('qr-result').innerHTML = '';
  showStep(2);
}

document.getElementById('passcode').addEventListener('keypress', e => {
  if (e.key === 'Enter') verifyPasscode();
});
</script>
</body>
</html>
