<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JooyMedia QR Scanner</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #FF6B35 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
    .logo {
      width: 120px;
      height: 60px;
      margin: 0 auto 20px auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 1.8em;
    }
    .mode-indicator {
      background: #4CAF50;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      margin-bottom: 20px;
      display: inline-block;
    }
    .mode-indicator.production {
      background: #F44336;
    }
    .step { display: none; animation: fadeIn 0.5s ease-in; }
    .step.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }
    input:focus { outline: none; border-color: #FF6B35; }
    button {
      background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 15px;
      transition: transform 0.2s;
    }
    button:hover { transform: translateY(-2px); }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .file-input {
      border: 2px dashed #FF6B35;
      padding: 30px;
      border-radius: 10px;
      margin: 20px 0;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .file-input:hover { background-color: #fff5f2; }
    .file-input.processing {
      border-color: #4CAF50;
      background-color: #f0f8f0;
    }
    .file-input input { display: none; }
    .result, .error, .success, .already-checked-in, .debug {
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .result { background: #f0f8f0; border: 2px solid #4CAF50; }
    .error { background: #fff0f0; border: 2px solid #f44336; color: #f44336; }
    .success { background: #f0f8f0; border: 2px solid #4CAF50; color: #4CAF50; }
    .already-checked-in { background: #fff8e1; border: 2px solid #ff9800; color: #e65100; }
    .debug { background: #f5f5f5; border: 2px solid #666; color: #333; text-align: left; font-family: monospace; font-size: 12px; }
    .loading {
      display: inline-block;
      width: 20px; height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #FF6B35;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .toggle-btn {
      background: #4CAF50 !important;
      font-size: 14px !important;
      padding: 10px 20px !important;
      margin-bottom: 10px;
    }
    .toggle-btn.production {
      background: #F44336 !important;
    }
    /* Mobile fixes */
    @media (max-width: 600px) {
      h1 { font-size: 1.4em; }
      input, button { font-size: 14px; padding: 12px; }
      .file-input { padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="JM-logo.png" alt="JooyMedia Logo" style="max-width:150px; height:auto;">
    </div>
    <h1>JooyMedia QR Scanner</h1>
    <div id="mode-indicator" class="mode-indicator">üß™ TEST MODE</div>
    
    <!-- Step 1: Passcode -->
    <div class="step active" id="step1">
      <h2>Enter Passcode</h2>
      <input type="password" id="passcode" placeholder="Enter event passcode" />
      <button onclick="verifyPasscode()">Verify Passcode</button>
      <div id="passcode-error"></div>
    </div>
    
    <!-- Step 2: QR Scanner -->
    <div class="step" id="step2">
      <button onclick="toggleMode()" id="modeBtn" class="toggle-btn">üöÄ Switch to PRODUCTION Mode</button>
      
      <h2>Scan QR Code</h2>
      <div class="file-input" id="fileInputArea" onclick="document.getElementById('qrFile').click()">
        <input type="file" id="qrFile" accept="image/*" onchange="handleFileSelect(event)">
        <p id="fileInputText">üì∑ Click to upload QR code image</p>
        <small>Supports JPG, PNG, HEIC (iPhone), GIF</small>
      </div>
      <button onclick="testWebhook()" style="background: #666; margin-top: 10px;">üîß Test Current Webhook</button>
      <div id="qr-result"></div>
    </div>
    
    <!-- Step 3: Success -->
    <div class="step" id="step3">
      <h2 id="result-title">‚úÖ Success!</h2>
      <div id="final-result"></div>
      <button onclick="resetScanner()">Scan Another QR Code</button>
    </div>
  </div>
<script>
let selectedFile = null;
let isProcessing = false;

// üî• FIXED CONFIG - Now supports both test and production URLs
const CONFIG = {
  PASSCODE: 'JM8888',
  USE_PRODUCTION: false, // Start in test mode by default
  URLS: {
    TEST: 'https://jooymedia.zeabur.app/webhook-test/b744552e-0801-408d-a84e-267196b27730',
    PRODUCTION: 'https://jooymedia.zeabur.app/webhook/b744552e-0801-408d-a84e-267196b27730'
  }
};

// Get current webhook URL based on mode
function getCurrentWebhookUrl() {
  return CONFIG.USE_PRODUCTION ? CONFIG.URLS.PRODUCTION : CONFIG.URLS.TEST;
}

function verifyPasscode() {
  const passcode = document.getElementById('passcode').value;
  const errorDiv = document.getElementById('passcode-error');
  if (passcode === CONFIG.PASSCODE) {
    showStep(2);
  } else {
    errorDiv.innerHTML = '<div class="error">‚ùå Invalid passcode. Please try again.</div>';
  }
}

// üî• IMPROVED: Auto-process when file is selected
function handleFileSelect(event) {
  const file = event.target.files[0];
  if (file && !isProcessing) {
    selectedFile = file;
    
    // Update UI to show file selected and processing will begin
    const fileInputArea = document.getElementById('fileInputArea');
    const fileInputText = document.getElementById('fileInputText');
    
    fileInputArea.classList.add('processing');
    fileInputText.innerHTML = `<span class="loading"></span>Processing: ${file.name}`;
    
    // Auto-process the QR code immediately
    processQR();
  }
}

// üî• FIXED: Toggle between test and production modes
function toggleMode() {
  CONFIG.USE_PRODUCTION = !CONFIG.USE_PRODUCTION;
  updateModeDisplay();
  
  const resultDiv = document.getElementById('qr-result');
  const mode = CONFIG.USE_PRODUCTION ? 'PRODUCTION' : 'TEST';
  const url = getCurrentWebhookUrl();
  
  resultDiv.innerHTML = `
    <div style="color: ${CONFIG.USE_PRODUCTION ? '#F44336' : '#4CAF50'}; font-weight: bold; padding: 10px; background: #f9f9f9; border-radius: 8px;">
      üì° Switched to <strong>${mode} MODE</strong><br>
      <small style="font-family: monospace;">${url}</small>
    </div>
  `;
  
  console.log(`Switched to ${mode} mode:`, url);
}

function updateModeDisplay() {
  const indicator = document.getElementById('mode-indicator');
  const toggleBtn = document.getElementById('modeBtn');
  
  if (CONFIG.USE_PRODUCTION) {
    // Production mode
    indicator.textContent = 'üöÄ PRODUCTION MODE';
    indicator.className = 'mode-indicator production';
    toggleBtn.textContent = 'üß™ Switch to TEST Mode';
    toggleBtn.className = 'toggle-btn production';
  } else {
    // Test mode
    indicator.textContent = 'üß™ TEST MODE';
    indicator.className = 'mode-indicator';
    toggleBtn.textContent = 'üöÄ Switch to PRODUCTION Mode';
    toggleBtn.className = 'toggle-btn';
  }
}

// Test current webhook connectivity
async function testWebhook() {
  const resultDiv = document.getElementById('qr-result');
  const webhookUrl = getCurrentWebhookUrl();
  const mode = CONFIG.USE_PRODUCTION ? 'PRODUCTION' : 'TEST';
  
  resultDiv.innerHTML = `<div class="loading"></div>Testing ${mode} webhook connection...`;
  
  try {
    console.log(`Testing ${mode} webhook URL:`, webhookUrl);
    
    const testPayload = { 
      test: true,
      qr_data: "TEST_TICKET_123", 
      timestamp: new Date().toISOString(), 
      source: 'connection_test',
      mode: mode.toLowerCase()
    };
    
    const response = await fetch(webhookUrl, {
      method: 'POST', 
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }, 
      body: JSON.stringify(testPayload)
    });
    
    console.log('Response status:', response.status);
    const responseText = await response.text();
    console.log('Response body:', responseText);
    
    if (response.ok) {
      resultDiv.innerHTML = `
        <div class="success">‚úÖ ${mode} webhook connection successful!</div>
        <div class="debug">
          <strong>Mode:</strong> ${mode}<br>
          <strong>URL:</strong> ${webhookUrl}<br>
          <strong>Status:</strong> ${response.status}<br>
          <strong>Response:</strong><br>${responseText}
        </div>
      `;
    } else {
      resultDiv.innerHTML = `
        <div class="error">‚ùå ${mode} webhook returned error status: ${response.status}</div>
        <div class="debug">
          <strong>URL:</strong> ${webhookUrl}<br>
          <strong>Response:</strong><br>${responseText}
        </div>
      `;
    }
    
  } catch (error) {
    console.error('Webhook test error:', error);
    resultDiv.innerHTML = `
      <div class="error">‚ùå ${mode} webhook connection failed: ${error.message}</div>
      <div class="debug">
        <strong>Mode:</strong> ${mode}<br>
        <strong>URL:</strong> ${webhookUrl}<br>
        <strong>Error:</strong> ${error.message}<br>
        <br>
        <strong>Possible causes:</strong><br>
        ${CONFIG.USE_PRODUCTION ? 
          '- N8N workflow is not activated<br>- Production webhook endpoint is not running<br>' : 
          '- Test webhook endpoint is down<br>'
        }
        - Network connectivity issues<br>
        - CORS policy blocking request
      </div>
    `;
  }
}

// Convert any image (HEIC, PNG, JPG) ‚Üí resized JPEG (max 1000px)
function shrinkImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        let width = img.width, height = img.height;
        const MAX = 1000;
        if (width > height && width > MAX) {
          height *= MAX / width; width = MAX;
        } else if (height > MAX) {
          width *= MAX / height; height = MAX;
        }
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);
        canvas.toBlob(blob => resolve(new File([blob], "qr.jpg", { type: "image/jpeg" })), "image/jpeg", 0.8);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// üî• IMPROVED: Removed button dependency, now auto-processes
async function processQR() {
  if (!selectedFile || isProcessing) { 
    return; 
  }
  
  isProcessing = true;
  
  try {
    console.log('Starting QR processing...');
    
    const smallFile = await shrinkImage(selectedFile);
    console.log('Image resized successfully');
    
    const formData = new FormData();
    formData.append('file', smallFile);
    
    console.log('Sending to QR API...');
    const response = await fetch('https://api.qrserver.com/v1/read-qr-code/', { 
      method: 'POST', 
      body: formData 
    });
    
    const result = await response.json();
    console.log('QR API result:', result);
    
    const qrData = result[0]?.symbol[0]?.data;
    
    if (qrData) {
      console.log('QR data extracted:', qrData);
      showQRResult(qrData);
      await sendToWebhook(qrData);
    } else {
      showError('‚ö†Ô∏è Could not read QR code. Please try again or choose a clearer image.');
      console.log('Failed to extract QR data from result:', result);
      resetFileInput();
    }
  } catch (err) {
    console.error('QR processing error:', err);
    showError('Error processing QR: ' + err.message);
    resetFileInput();
  } finally {
    isProcessing = false;
  }
}

function showQRResult(qrData) {
  const mode = CONFIG.USE_PRODUCTION ? 'PRODUCTION' : 'TEST';
  document.getElementById('qr-result').innerHTML = `
    <div class="result">
      üì± QR Code Decoded: <strong>${qrData}</strong><br>
      üöÄ Sending to <strong>${mode}</strong> webhook...
    </div>
  `;
}

// üî• FIXED: Now uses dynamic webhook URL
async function sendToWebhook(qrData) {
  const webhookUrl = getCurrentWebhookUrl();
  const mode = CONFIG.USE_PRODUCTION ? 'production' : 'test';
  
  const payload = { 
    qr_data: qrData, 
    timestamp: new Date().toISOString(), 
    source: 'custom_scanner',
    mode: mode
  };
  
  console.log(`Sending payload to ${mode} webhook:`, payload);
  console.log('Webhook URL:', webhookUrl);
  
  try {
    const response = await fetch(webhookUrl, {
      method: 'POST', 
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }, 
      body: JSON.stringify(payload)
    });
    
    console.log('Webhook response status:', response.status);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('Webhook error response:', errorText);
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    // Parse the response from your n8n workflow
    const webhookResponse = await response.json();
    console.log('Webhook response data:', webhookResponse);
    
    // Handle different response types
    if (webhookResponse.success === true && webhookResponse.status === 'checked_in') {
      // SUCCESS: New check-in
      showCheckInSuccess(webhookResponse);
    } else if (webhookResponse.success === false && webhookResponse.status === 'already_checked_in') {
      // ERROR: Already checked in
      showAlreadyCheckedIn(webhookResponse);
    } else {
      // Fallback for unexpected responses
      showGenericSuccess(qrData, webhookResponse);
    }
    
  } catch (error) {
    console.error('Webhook error:', error);
    showError(`Failed to process check-in (${mode.toUpperCase()} mode): ${error.message}`);
    
    // Show debug info
    document.getElementById('qr-result').innerHTML += `
      <div class="debug">
        <strong>Debug Info:</strong><br>
        Mode: ${mode.toUpperCase()}<br>
        QR Data: ${qrData}<br>
        Webhook URL: ${webhookUrl}<br>
        Error: ${error.message}<br>
        ${CONFIG.USE_PRODUCTION ? '<strong>üí° Tip:</strong> Make sure your N8N workflow is ACTIVATED!' : ''}
      </div>
    `;
    resetFileInput();
  }
}

function showCheckInSuccess(webhookResponse) {
  const mode = CONFIG.USE_PRODUCTION ? 'PRODUCTION' : 'TEST';
  document.getElementById('result-title').innerHTML = `‚úÖ Check-in Successful! (${mode})`;
  document.getElementById('final-result').innerHTML =
    `<div class="success">
       <h3>Welcome to the event! üéâ</h3>
       <p><strong>Name:</strong> ${webhookResponse.name || 'N/A'}</p>
       <p><strong>Ticket:</strong> ${webhookResponse.ticket_number}</p>
       <p><strong>Status:</strong> Successfully checked in</p>
       <p><strong>Mode:</strong> ${mode}</p>
       <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
     </div>`;
  showStep(3);
}

function showAlreadyCheckedIn(webhookResponse) {
  const mode = CONFIG.USE_PRODUCTION ? 'PRODUCTION' : 'TEST';
  document.getElementById('result-title').innerHTML = `‚ö†Ô∏è Already Checked In (${mode})`;
  document.getElementById('final-result').innerHTML =
    `<div class="already-checked-in">
       <h3>This ticket has already been used</h3>
       <p><strong>Ticket:</strong> ${webhookResponse.ticket_number}</p>
       <p><strong>Status:</strong> Already checked in</p>
       <p><strong>Mode:</strong> ${mode}</p>
       <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
       <p><em>Please contact event staff if this is an error.</em></p>
     </div>`;
  showStep(3);
}

function showGenericSuccess(qrData, webhookResponse) {
  const mode = CONFIG.USE_PRODUCTION ? 'PRODUCTION' : 'TEST';
  document.getElementById('result-title').innerHTML = `‚úÖ QR Code Processed (${mode})`;
  document.getElementById('final-result').innerHTML =
    `<div class="success">
       <h3>QR Code Processed Successfully!</h3>
       <p><strong>Ticket:</strong> ${qrData}</p>
       <p><strong>Mode:</strong> ${mode}</p>
       <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
       ${webhookResponse ? `<div class="debug">Response: ${JSON.stringify(webhookResponse, null, 2)}</div>` : ''}
     </div>`;
  showStep(3);
}

function showError(msg) {
  document.getElementById('qr-result').innerHTML = `<div class="error">${msg}</div>`;
}

function showStep(n) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById(`step${n}`).classList.add('active');
}

// üî• NEW: Reset file input area to original state
function resetFileInput() {
  const fileInputArea = document.getElementById('fileInputArea');
  const fileInputText = document.getElementById('fileInputText');
  
  fileInputArea.classList.remove('processing');
  fileInputText.innerHTML = 'üì∑ Click to upload QR code image';
}

// üî• IMPROVED: Reset scanner completely
function resetScanner() {
  selectedFile = null;
  isProcessing = false;
  document.getElementById('qrFile').value = '';
  document.getElementById('qr-result').innerHTML = '';
  resetFileInput();
  showStep(2);
}

// Initialize display
document.addEventListener('DOMContentLoaded', function() {
  updateModeDisplay();
});

document.getElementById('passcode').addEventListener('keypress', e => {
  if (e.key === 'Enter') verifyPasscode();
});
</script>
</body>
</html>
